// --- ESTE ARCHIVO REPRESENTA EL C√ìDIGO QUE CORRER√çA EN UN SERVIDOR SEGURO (Serverless Function) ---
// Su √öNICA funci√≥n es calcular la previsi√≥n con la IA y guardarla en Firestore.
// De esta forma, tu clave de API queda protegida y la web es instant√°nea.

// Importaciones necesarias para Node.js (entorno Serverless)
// En un entorno real, descomentar√≠as estas l√≠neas y har√≠as la configuraci√≥n.
/* const { GoogleGenAI } = require("@google/genai");
const { initializeApp } = require('firebase-admin/app');
const { getFirestore } = require('firebase-admin/firestore');
*/

// Datos actuales de la estaci√≥n (Esto vendr√≠a de tu base de datos o API)
const currentWeatherData = {
    temp: "23.5¬∞C",
    humidity: "65%",
    pressure: "995.8 hPa", // Presi√≥n bajando r√°pidamente = riesgo de tormenta/cambio brusco
    wind_speed: "35 km/h",
    wind_direction: "Suroeste",
    rain_last_hour: "0 mm",
};

// ** IMPORTANTE: Aqu√≠ se simula la llamada a la IA de Gemini
async function generateForecast(data) {
    // En un script real, aqu√≠ usar√≠as tu API Key SECRETA para llamar a Gemini
    /*
    const ai = new GoogleGenAI({ apiKey: "TU_API_KEY_SECRETA_AQUI" });
    const prompt = `Analiza...` // El prompt ir√≠a aqu√≠
    const response = await ai.models.generateContent({ ... });
    return JSON.parse(response.text);
    */

    // El siguiente prompt es lo que le enviar√≠as a Gemini
    const prompt = `Analiza estos datos meteorol√≥gicos y genera un pron√≥stico estructurado para una estaci√≥n clim√°tica dom√©stica.
Datos: ${JSON.stringify(data)}
Genera un objeto JSON con las siguientes claves:
1. simple_summary_title: T√≠tulo conciso (M√°x 5 palabras)
2. simple_summary_text: Resumen de la situaci√≥n actual y la conclusi√≥n m√°s importante.
3. current_analysis: An√°lisis detallado de los datos (Presi√≥n, Viento, Temperatura), enfoc√°ndose en la din√°mica atmosf√©rica (ascenso/descenso de presi√≥n). Utiliza un lenguaje profesional y explicativo.
4. forecast_6h_points: Array de 4 a 6 puntos clave para las pr√≥ximas 6 horas, detallando c√≥mo evolucionar√°n las condiciones.
5. forecast_3d_points: Array de 4 a 6 puntos clave para los pr√≥ximos 3 d√≠as.
6. alert_level: Uno de 'stable' (estable), 'vigilance' (vigilancia), o 'alert' (alerta) basado en la peligrosidad.
7. timestamp: Fecha y hora de la generaci√≥n.
`;

    // --- SIMULACI√ìN DEL RESULTADO DE LA IA (Reflejando un riesgo de tormenta) ---
    const analysisResult = {
        simple_summary_title: "ALERTA: Descenso R√°pido de Presi√≥n",
        simple_summary_text: "La presi√≥n ha ca√≠do a 995.8 hPa junto a vientos fuertes del Suroeste (35 km/h). Esto indica la inminente llegada de un frente fr√≠o y alta probabilidad de tormentas en las pr√≥ximas horas.",
        current_analysis: "Se observa un panorama din√°mico y de riesgo. La ca√≠da r√°pida en la presi√≥n atmosf√©rica (995.8 hPa) es el indicador principal de un cambio meteorol√≥gico brusco, con el acercamiento de un sistema de bajas presiones. Los vientos sostenidos del Suroeste (35 km/h) son t√≠picos de los frentes de tormenta. La humedad es moderada, pero con la entrada de aire fr√≠o y la convergencia de masas de aire, la formaci√≥n de nubes de desarrollo vertical (Cumulonimbus) es altamente probable.",
        forecast_6h_points: [
            "‚õàÔ∏è **Riesgo ALTO de Tormentas:** La probabilidad de precipitaciones intensas comenzar√° en las pr√≥ximas 2 horas.",
            "üìâ **Ca√≠da de Temperatura:** La temperatura descender√° bruscamente tras el inicio de la lluvia.",
            "üí® **Rachas de Viento:** Se esperan r√°fagas que podr√≠an superar los 50 km/h al inicio de la tormenta.",
            "‚òîÔ∏è **Acumulaci√≥n de Lluvia:** Se prev√©n acumulaciones significativas durante las primeras 3 horas.",
            "‚ö°Ô∏è **Actividad El√©ctrica:** Alta posibilidad de actividad el√©ctrica intensa.",
        ],
        forecast_3d_points: [
            "üåßÔ∏è **D√≠a 1:** Clima inestable. Tras la tormenta inicial, se mantendr√°n chubascos intermitentes.",
            "üå•Ô∏è **D√≠a 2:** Mejora gradual. El cielo se nublar√° menos, pero la presi√≥n se mantendr√° baja.",
            "üåû **D√≠a 3:** Estabilidad. Se espera que la presi√≥n comience a subir por la tarde, augurando un clima soleado para el d√≠a siguiente.",
            "üå°Ô∏è **Temperaturas:** Las temperaturas se mantendr√°n por debajo del promedio para la estaci√≥n.",
            "üí® **Viento:** Disminuci√≥n progresiva del viento durante el per√≠odo, volviendo a la calma en el D√≠a 3.",
        ],
        alert_level: 'alert', // Esto cambia el color del dashboard a ROJO
        timestamp: new Date().toLocaleDateString('es-ES') + ' ' + new Date().toLocaleTimeString('es-ES'),
    };

    return analysisResult;
}

// ** FUNCI√ìN PRINCIPAL DE EJECUCI√ìN (Llamada por el trigger de Serverless)
async function mainFunction(appId) {
    console.log(`[SERVERLESS] Iniciando c√°lculo de previsi√≥n para App ID: ${appId}`);

    try {
        // 1. Obtener los datos y generar el an√°lisis (Llamada a Gemini)
        const newAnalysis = await generateForecast(currentWeatherData);

        // 2. Conectar a Firestore (En un entorno Serverless - Omitido en este mock)
        // const db = getFirestore();

        // 3. Definir la ruta de destino (P√öBLICA) - DEBE COINCIDIR CON LA WEB
        const path = `/artifacts/${appId}/public/data/latest_forecast/analysis_doc`;
        
        // 4. Escribir el an√°lisis completo en la base de datos (Omitido en este mock)
        // await db.doc(path).set(newAnalysis);

        console.log(`[SERVERLESS] ‚úÖ An√°lisis generado y listo para ser le√≠do en Firestore en la ruta: ${path}`);
        console.log(`[SERVERLESS] Contenido guardado:`, newAnalysis.simple_summary_title);

    } catch (error) {
        console.error("[SERVERLESS] ‚ùå Error en el proceso de IA/Firestore:", error);
    }
}

// Para hacer la prueba, usa un ID de App de ejemplo
// mainFunction('default-app-id');
